<metadata>
90ac5669a6de2c41abc7c2e2acdaacc9354750238ae3583708660a373210b9885c72f1c12f0dc8e8187d432d8dee711e76125f36fd934d2af3ce86a49ce96014e680b499b78fefcde8d70c32e3df0964e58adabeb7c29bf7167327071365abce6e1c99ea2d441d7280ee34097f5d4f7e547a8fbf0d2fae90734fdeb09bfacca15d38f1cffeb5adccd3a62741ddb021408fe188a81c5dd9bd0b6a85f5deaa620ba6d0a1c42e0eafe20f6000764c2519775c3b31111253611766033c4e7514bfd8a6c31c2091becca23150f5984227e7d9063a7703e9903646cfaaa09e5a13ed8371154a23dcbfe889d5a178173341fcc085aa4a3ee990e59588eda799003cff93f293ed839ef93f4a56376007dcb90638d19c6233e4a8685cd9e5f2dda7cbfd9c92fca9ce7702bfdee98eef8a093797abbcdd89fc83f779116708e290d4eaa39fe9c69afbc4b15226cca4a7c8394b330d5468e48783ec036e1d6d82e3b7d9b2cb4c72cff3b7987d1ef996315c75056809224c374e556b063a6c0fc7a85d30660b22476608e0949ae9152beca584f71333e3829af456766207e49cb7c7523d97f94722452bea9e7d1496f7a7cb2808196a82f6d1a8b4d830557d5d70118afcdabf255781e0412601646e4e98eff69fb8cc92fa4565fa9b81a196e591fc046bec83641018707e178ce26d0a3c1c6713127a61005e2ad1f1f482aacbd3a1bdd4147185f695b5ceafd8bbc2a1b8d7d8aa5531e28bbfd17f18b19144300966a4848af8593c3754214485eb8df93a1ad0b45a3bb8cccbaa4a641824d2fd7e1d6f003459fd904f2ac4aa5b2f3e4d90aedde15b38aac594e42e574a386a03e681224aec98d6a5c9f7794559763f5c88e70676a5dc73011d7489ee9df50672f6850d33516db4d0dcbd75016306f4bb3254e9aaff8d17726d0c52267d14aec1127c09377b4a5660e5cb4c7d3705f8d6ba88cbfb97a78bb2f0cc012ebcd8debf9eeaa1c4703fd7b1abe8146620451e7f3743b5dc3e51224c89b738042a4fb9c112625e1ae283483cc6a3ab9596a63908032da6967948eec068586353dded1726edd1e2cde3863e4695e52662b9d8611595f0f4ca211d9ded4d2cc4b76c1ff483c4ab97e534508cb295a9b49b6b1b34556d1e4437f4833d526c1ee7831826d2ee82ed5f2a0e7a99e9087d7c08e4da5b0064413d6d184a97d83077e5b79bda397453769ec348143b726d035f3b127b5635d0b145314728dcaeaeddda86caf6426dcca3582d8afe7101483d413538069fa36e0b28501170523c1c502041b2dc0265655b5e0ea8da36593a6ec1b38aebd6b2cbae36447b372d4cb1df4b2c5421dbba1176b9dc0834654ad2b7a0d856372f41f1bd11700866d5b2f7c9033f91e30a6f3553a7c22052abcec4aafe9d9bfe9cef7f41704c235192f79afcdcb9b0c2bbde402ed6b5a1c44d73560db792fcacd38199d6df98c99bbdfc014c1c39bae7336f0f5fa7c694f7771cb9d835526a0fa4d781dd29447809076bb387103e33436003c1acbb87ac8361131c7916700762cdbf7015a1cf95f677123c023d018da27507066387e1f2974436a5c0c8a66605bedbd5a6d5eba995aec7e789254190f9fb983554e397204fb1c3fbb4a3d381f587ee0c63593774072909295a99fca5d5badbd3a160017307c1a498a52f0d04426706ee82d4a7096cae8ce4daa69a5a36bad3bad43b5e9cbc046ad1b0b3de3752b28fc9ebe4a8b8d1e688fb9edafab0818ba93616dbb84926eb8756392755ccf16547785571497340380d52675f682514fac82301123240338efa463f076b4e2bfcc18fad477795b7dcfc4d3ad1b80266f2864e26ffc25476132251738dade99a067f016c17757b140b67a09d67451527b382a3942b09a7871a6caec7f6850069cba9e08c0663e5d8e3c1c89c81f3790cfe9bc3e186b8d9e58ca39df198f13b553752a9978eb2e28ea0c93856a6c3042406682e4f58350d680c311230b5f9d7bef19f3d58ebcba5943210f3d3b4d78de21b7706690577b885c1e3735eb283a69095a284b30335ead32214c7f6bd9f7353bbc84a3e09701d710267b68bfbd95b6bc4e6d9f93146224b4125285c2d45407d9cbefecf34167f5faedd473e2d40680aa4cbcfa3f8c55f7dc8fa14259ea98aa898b80e78a2cba3d00a630466167a8eebb38e2e0cc99d9ae86d185237486a7b45526e99b679152a43b1df5a3f4a74b58991fd0f66cba5a7c2e4c4355b1170adc03550a19cb092e0acf9901d737f1a785866540b29f0d0b2d1f09f3a569ff0e1930538a280220f754325105065fbc84e7821036141a2d188fcb9c0dab642270f32b99becdcba985b7bd3a4d4bdd0b48df9f49c86bbccee84b54c6e82a29ae9dfa619747311e58a2844714c0e2c9dafd8e9e4d33b1988a8394fc8a16f1cfe97ff9d6e02f89d0835e0c2e9bd077598ed1f7ae8ca2b159aa67b541a767b12640a05606856162aa887c7ae422c85e18ce50c6f4d2cd9adc9a6f98b5b1415652357167f4b243e50c0b3f1cf506c55268de88ffd4a236a0f0b780836c2843a5b1e72b3c06a0f7448d8f70576f19495e719707a1fc5b6fbc5aa967d0fa8cd166232661c65ccbc4227112f6125325d4c3990f25c302441b488a48b6f1d0c69daaebde9a9d04a3a81e4457bf6ca016c81e092ea7e3cbedfe1936a19e4a6ee8fbbd85b30fec097a72e125679305d4a2b354d2062b4d52654b5c676346a0b3f5c39528bb53408bedbabc5b2d385e789e5ff9ab6f7b6da5e3b80f23044bac91e200a4cfe9f0b672b58afca487479565035e58bc5a48eecee82c0a53776c9a5ceabaddfaadefe8de3dd2c10acc9a7c965042547b5d9680d5a19f09d56224a387108a698f3b569084a26b8cbd4b1ad91f2dd3a5fbcd22e4f42208ae600657c3f492426525d2f225b2d138ab68fea610fe081b7d50e627411a6ef0967483ce49608690e6c85e49ae8d1ef286e1f7eb2de5e2d284d93af517e583d147ac9a87f1d8ce0ff9aa1e8a8c61a6eb4c645243250cdacd7a5bb856c504768cda0cea111755722573b81e48db3b5619835540bd719e5d2e0ea59465428
</metadata>
//---------------------------------------------------
// Project: KAMA
// Language: MQL4
// Type: Indicator
// Author: 
// Company: 
// Copyright: 
// Created: 16.12.2009
//---------------------------------------------------
#property indicator_chart_window
#property indicator_buffers 3
#property indicator_color1 Gray
#property indicator_color2 Blue
#property indicator_color3 Red
//---- input parameters
extern int       periodAMA=10;
extern double    nfast=2.0;
extern double    nslow=30.0;
extern double    G=2.0;
extern double    dK=2.0;
extern int       PriceType=0; 
extern int       AMA_Trend_Type=1;
//---- buffers
double AMAbuffer[];
double upAMA[];
double downAMA[];
double AbsBuffer[];

double AMA2Buffer[];
double SumAMABuffer[];
double StdAMA[];

double slowSC,fastSC,dFS;

double Price(int shift)
  {
//----
   double res;
//----
   switch (PriceType)
      {
      case PRICE_OPEN: res=Open[shift]; break;
      case PRICE_HIGH: res=High[shift]; break;
      case PRICE_LOW: res=Low[shift]; break;
      case PRICE_MEDIAN: res=(High[shift]+Low[shift])/2.0; break;
      case PRICE_TYPICAL: res=(High[shift]+Low[shift]+Close[shift])/3.0; break;
      case PRICE_WEIGHTED: res=(High[shift]+Low[shift]+2*Close[shift])/4.0; break;
      default: res=Close[shift];break;
      }
   return(res);
  }
//+------------------------------------------------------------------+
//| Custom indicator initialization function                         |
//+------------------------------------------------------------------+
int init()
  {
//---- indicators
   IndicatorBuffers(7);
   SetIndexStyle(0,DRAW_LINE);
   SetIndexBuffer(0,AMAbuffer);
   SetIndexStyle(1,DRAW_ARROW,0,2);
   SetIndexArrow(1,159);
   SetIndexBuffer(1,upAMA);
   SetIndexEmptyValue(1,0.0);
   SetIndexStyle(2,DRAW_ARROW,0,2);
   SetIndexArrow(2,159);
   SetIndexBuffer(2,downAMA);
   SetIndexEmptyValue(2,0.0);
   
   SetIndexBuffer(3,AbsBuffer);
   SetIndexBuffer(4,AMA2Buffer);
   SetIndexBuffer(5,SumAMABuffer);
   SetIndexBuffer(6,StdAMA);
   
   slowSC=(2.0 /(nslow+1));
   fastSC=(2.0 /(nfast+1));
   dFS=fastSC-slowSC;
   
   
//----
   return(0);
  }
//+------------------------------------------------------------------+
//| Custom indicator deinitialization function                       |
//+------------------------------------------------------------------+
int deinit()
  {
//----
   
//----
   return(0);
  }
//+------------------------------------------------------------------+
//| Custom indicator iteration function                              |
//+------------------------------------------------------------------+
int start()
  {
   int    counted_bars=IndicatorCounted();
//----
   int i,limit,limit2;
   double Noise,ER,SSC;
   double SredneeAMA,SumKvadratAMA;
   double val1,val2;
   double dipersion;
   static bool debug=false;
   
   if (debug) return;
   if (counted_bars>0) 
      {
      limit=Bars-counted_bars; 
      limit2=limit;
      }
   if (counted_bars==0)
      {
      ArrayInitialize(AMAbuffer,0);
      ArrayInitialize(upAMA,0);
      ArrayInitialize(downAMA,0);
      ArrayInitialize(AbsBuffer,0);
      ArrayInitialize(AMA2Buffer,0);
      ArrayInitialize(SumAMABuffer,0);
      ArrayInitialize(StdAMA,0);
      
      limit=Bars-1;
      limit2=Bars-periodAMA-1;
      }
   limit--;
   limit2--;
    for (i=limit;i>=0;i--)
      {
      AbsBuffer[i]=MathAbs(Price(i)-Price(i+1));
      }   
    for (i=limit2;i>=0;i--)
      {
      Noise=iMAOnArray(AbsBuffer,0,periodAMA,0,MODE_SMA,i)*periodAMA;
      if (Noise!=0) ER=MathAbs(Price(i)-Price(i+periodAMA))/Noise; else ER=0;
      SSC=MathPow(ER*dFS+slowSC,G);
      AMAbuffer[i]=Price(i)*SSC+AMAbuffer[i+1]*(1-SSC);
      AMA2Buffer[i]=AMAbuffer[i]*AMAbuffer[i]+AMA2Buffer[i+1];
      SumAMABuffer[i]=SumAMABuffer[i+1]+AMAbuffer[i];
      }   
   for (i=limit2;i>=0;i--)
      {
      val1=0;
      val2=0;
      SredneeAMA=(SumAMABuffer[i]-SumAMABuffer[i+periodAMA])/periodAMA;
      SumKvadratAMA=AMA2Buffer[i]-AMA2Buffer[i+periodAMA];
      dipersion=SumKvadratAMA/periodAMA-SredneeAMA*SredneeAMA;
      if (dipersion<0)
         {
         StdAMA[i]=0;
        
         if (IsTesting()&&false)
            {
            Print("Bar;Price;AbsBuffer;AMAbuffer;AMA2Buffer;SumAMABuffer;SredneeAMA");
            for (int Z=Bars-1;Z>=i;Z--) Print(Z,";",Price(Z),";",AbsBuffer[Z],";",AMAbuffer[Z],";",AMA2Buffer[Z],";",SumAMABuffer[Z],";",(SumAMABuffer[Z]-SumAMABuffer[Z+periodAMA])/periodAMA);
            }
         
         }
      else StdAMA[i]=MathSqrt(dipersion);

      if (AMA_Trend_Type!=0)
         {
         if (MathAbs(AMAbuffer[i]-AMAbuffer[i+1])>dK*Point)
            {
            if (AMAbuffer[i]-AMAbuffer[i+1]>0) val1=AMAbuffer[i];
            else val2=AMAbuffer[i];
            } 
         }
      else
         {
         if (MathAbs(AMAbuffer[i]-AMAbuffer[i+1])>dK*StdAMA[i])
            {
            if (AMAbuffer[i]-AMAbuffer[i+1]>0) val1=AMAbuffer[i];
            else val2=AMAbuffer[i];
            } 
         }         
      upAMA[i]=val1;
      downAMA[i]=val2;
      }
  
//----
   return(0);
  }
//+------------------------------------------------------------------+