<metadata>
8ab6ba85bfc7325f9ef268483a4cf792c0b27f0c98f1d4bbc1af4b764b6980b190be4474735122028beed6b8264587e82e4aa2cbb4da2a4d0d30c1e3b3c67602bfd9c9e430081d3fe3dcdee0566a6e036b042f4bfa8f88e410758eae23555f3aa3d12152d3baf897a9c71e235a78ccfd6e40eede36141927506c90fe0362a3ce2144d1efa3e089ca276e1529fcd3b3dd6b0a234e99fc9ca214282b5f0b72ea9a13769ea0327bb2dc4c28462f593ad4b51f6b650a8cfec1fde4cb3642ec9575058de881bf9ca0e985accde48aaccbdda81f7ebbdce88d4678682585d498d4d4e0576b5778dcb0aacbed83e384d3a67415d2b54f2a605e58644829a0d56511aec6d8b785f787b90068cabe98ecbcccd0eafcd3fed1295e3d4ad7a0eec0fd90f39640347f1ee0912752ff90bdc9e58010633719e58baacfd6a2042b5b67517ec9a8bfcab1c5d7bf432c691b526c1d211d7ec4aba9c486f6d1b04826225b4a74b0f3f699abc65f2f6a0b2d43c4bd0a36c2ed15763956234e42327d1c442ac6bf556b6f53d7b4107fb4d96d000663157bb2c688fb2d139aa6e5cab2d1a0cf513cd0bd7217b4da7d09176409374e720665630cff8fa9d0c6b4aac3791e86ee1561f3803b05c98a335c0070a2dbeb999bf25235234b1c682e0e862f3616586a2c1c96a62d19a38f3b1b0d4044212e5a55348edf3a4f1d723e4a4a2fdead96b6fba8620dd6b05125b3c427460173afcac1e13f7c88e7a0d26818e0ce5f631a3596f54b24c4b4770edba9e48db5d249212b5fdaa96856477b452108693a4ea6c3c887f294fdbe73011b7e91f0d1a5bcd55d32204e93adac9e6c58604e72425664557b281a4c7c17264b7aa29e230c7f1b5b3afb8fa0c5551a88eeb5f6dba91d784f2e5723234aed82610f5c628ab66104067eaddd9eda3a5baade5134f6c821115667dff1cefe3706c2ec18287949d7e7b9889fa3e9c68bee522afa8aa1e55a3bd7a350354e7008347303dfbe27546a1914631877d5a7ff9bfcc293af143b7606a7c6c7b4c1b28bfc99f6d1a3ef8b3b05e5d9046181f90a6bf59b8ac6b8d99cf291f6a19fe7b7dba9adc2c7937f0dc6a7f89c80e5d0a23975e180c2ac4324a2d70667a7c04d284975f8d78de83b436100c7a9266a3b5acea0a4c3d6e8417de99bf99cd5b3c6a3502293f6ff9121425732d5a6340a635f631165007016e1845e2c593c4c226003bcd9a09e38633e1b5d0d0e5cf8b747000a587938266bc7e2eeb33b675707b6d7a8cb62096001b8dfb0d50e7da8f4a0cdbdcce4880531d0fee39386e5432e5f638ea196e4c7a29dfb5d38ea98f095abc55c3ff491d6e8c4f8153a5426ceabcea89df84f3dd2b74d23593a24415e2d625c95a9fc95234de084432ad4b70d6c0571650a75070e41beceb0c4630af19e5d3301721b3bec9f2144e3939bfae092c4a5a8dced883b0677557a2e780a5d283a5f94b678466e52cea2234a7f11ff9aa7874a24167783ee5633d9e4fedcafe384edf09ee68390b0cffe82a0c7e7a4c7c2ad6e02c8a7d5a79ca192b03b1672433400ebddd3e023174e7d85b7ccfac5e74060ec9f6c18661f701c690c625fe2c0cefe86a43818c1b6c0a93d595d29d5bdf3ce5c7e95a482a082a21a6981f8b8d56c0e5c3382ee69542103f7c55465013680a2bb9b394f375ef487a1c8c8aacca0c4a1d8e585a7affbea982a5ffd9887a58ab41f23674892fe7a13345a2045cbf59aa66d42781189e7791d630adfbc58394b3f8fe06113410e7909beca5c356a05bcd27003c3fd87bbb2c19efb4e3cc4adff9a3b48a19f99df1c7d09655122224769557758c5b62045c4b6a8c1e782e5961628516dcebcd3b6384cde8ae29b98e889ec7c426f2b600f2e5bea885834cfaa39054d623f4db1d41e6a88dcc2bba8d8dbbef4ca8bb7c2af721397ef0f4d70110d7f1467d09232535d3eef845f613f0f97ab9ab59ff25b3a413950128aebbecc57244e0c5e3f37541f7493ad102c2e4bdfb182e395f7ec80b4d1abeab9d599fc81f36e1afc8fcdf3b2f481e0076b0c7f6401013d0728d6b387e9e180fc9ec7abbbdea8e9e78b6306ddaf8cf8e89beed0063a2247cfa13b5aee8c8ce0583dfcbfb3de81f53446661fbc82b0f6b6d72e42d3a0dabf6e521936e0851977016052302844294ce3a08be62b5fbdcf354cc7f9417dd8bdd6b8cdac5d3f7c1097f269206e001367a6d492f3583a1e7f5a28d8e65412294808649deec3a65965644ba7c288e611707416533f5a3f1c550e607b0fdaa82a4bc2a0a2c34f3d142a3f03bf90a6cb5d325236681dcea2096ccbf57702fc7b864a325aab73ec1727e7694d
</metadata>
//+------------------------------------------------------------------+
//|                                                          CCI.mq4 |
//|                      Copyright © 2004, MetaQuotes Software Corp. |
//|                                       http://www.metaquotes.net/ |
//+------------------------------------------------------------------+
#property copyright "Copyright © 2004, MetaQuotes Software Corp."
#property link      "http://www.metaquotes.net/"
//----
#property indicator_separate_window
#property indicator_buffers 1
#property indicator_color1 LightSeaGreen
//---- input parameters
extern int CCIPeriod = 14;
//---- buffers
double CCIBuffer[];
double RelBuffer[];
double DevBuffer[];
double MovBuffer[];
//+------------------------------------------------------------------+
//| Custom indicator initialization function                         |
//+------------------------------------------------------------------+
int init()
  {
   string short_name;
//---- 3 additional buffers are used for counting.
   IndicatorBuffers(4);
   SetIndexBuffer(1, RelBuffer);
   SetIndexBuffer(2, DevBuffer);
   SetIndexBuffer(3, MovBuffer);
//---- indicator lines
   SetIndexStyle(0, DRAW_LINE);
   SetIndexBuffer(0, CCIBuffer);
//----
   if(CCIPeriod <= 0)
       CCIPeriod = 14;
//----
   SetIndexDrawBegin(0, CCIPeriod);
  
//---- name for DataWindow and indicator subwindow label
   short_name="CCI(" + CCIPeriod + ")";
   IndicatorShortName(short_name);
   SetIndexLabel(0, short_name);
//----
   return(0);
  }
//+------------------------------------------------------------------+
//| Commodity Channel Index                                          |
//+------------------------------------------------------------------+
int start()
  {
   int    i, k, counted_bars = IndicatorCounted();
   double price, sum, mul; 
   if(CCIPeriod <= 1)
       return(0);
   if(Bars <= CCIPeriod) 
       return(0);
//---- initial zero
   if(counted_bars < 1)
     {
       for(i = 1; i <= CCIPeriod; i++) 
           CCIBuffer[Bars-i] = 0.0;
       for(i = 1; i <= CCIPeriod; i++) 
           DevBuffer[Bars-i] = 0.0;
       for(i = 1; i <= CCIPeriod; i++) 
           MovBuffer[Bars-i] =0.0;
     }
//---- last counted bar will be recounted
   int limit = Bars - counted_bars;
   if(counted_bars > 0) 
       limit++;
//---- moving average
   for(i = 0; i < limit; i++)
       MovBuffer[i] = iMA(NULL, 0, CCIPeriod, 0, MODE_SMA, PRICE_TYPICAL, i);
//---- standard deviations
   i = Bars - CCIPeriod + 1;
   if(counted_bars > CCIPeriod - 1) 
       i = Bars - counted_bars - 1;
   mul = 0.015 / CCIPeriod;
   while(i >= 0)
     {
       sum = 0.0;
       k = i + CCIPeriod - 1;
       while(k >= i)
        {
          price =(High[k] + Low[k] + Close[k]) / 3;
          sum += MathAbs(price - MovBuffer[i]);
          k--;
        }
       DevBuffer[i] = sum*mul;
       i--;
     }
   i = Bars - CCIPeriod + 1;
   if(counted_bars > CCIPeriod - 1) 
       i = Bars - counted_bars - 1;
   while(i >= 0)
     {
       price = (High[i] + Low[i] + Close[i]) / 3;
       RelBuffer[i] = price - MovBuffer[i];
       i--;
     }
//---- cci counting
   i = Bars - CCIPeriod + 1;
   if(counted_bars > CCIPeriod - 1) 
       i = Bars - counted_bars - 1;
   while(i >= 0)
     {
       if(DevBuffer[i] == 0.0) 
           CCIBuffer[i] = 0.0;
       else 
           CCIBuffer[i] = RelBuffer[i] / DevBuffer[i];
       i--;
     }
//----
   return(0);
  }
//+------------------------------------------------------------------+