<metadata>
ab97dee1b9c1e28fc4a803234e38c5a0f1834e3d076efc939cf2e0dd0b290c3de2cc3505a7850c2c4520137de784402fcaae5c35a6c896f1ccf1f3d1c1b4bdc9a2c495b80a322b0994abffc185b9bbd66b041a7e2451a8c4a2c799b965136603acde4e3dff961679503ecdf0fbd92819735da292fddf4d7365592846ccaddcb1ed889da38fce7e3af3ab231fbf90640a2b4ac0ad4d289ea0102ccabe1f6684f44421fbc55b12ddb35f3b523be88bb2d3a9dd7718d9ab2519cfe03145057cccbcaacfa09e003c482488e9b6d83156cabfcdacec8b4b2eb18f8ac76938a7ebaa9e172bc5ea3e52f2935d339ef903762d4c7f189cf9655bae92127303765d296d055f30196beed0e58df68236427a0a7d47416e7d527007d8af7a0dd4fa660bc1a45f2b6d0c9ced80f59df29ce8ed88a6d5062880ee6e0b9bef527dffc3644b543514615d29375f345b1567605e271b8be8b0df670a5525bedf9ff1bcc5013f211dc1eed6b509660b66f88852337f113f46dfe1c5f90764fc935b36771aacc9c4aa7206a3d0734ddfe3b59acdae523da1cc82ef60057b159ce8b0c399a7dfe30261c1ae9ded7801b4c6355c83e4c4ac5a2e641726183b78026d88f8fe87c3b1adc427401179acd80020d1787b5bb3810f3f4878ad995975a383501d4d28f6825b3a471676038ce333477c1971026e4e72214b24791fbfcbf5825736bcceb7d2486811523f50d5a73949e3cdfec2c7e83053036cb1c1344db3c1066f4e2978109aeee695003e6a5691f5c2a31e6acfaa723d4d2bf4b789fb3d58ef8e8afe6108c7a8a8c6330d0230f5cc517f0938596b7c52281aa090ebda675788b4a48bd4b098f97a0ebedba4eb90f63b78a9dba6c386e7d0a40069711e7b15f8c6b38fa6c3156dc8b8e7a39bfa166292f77d435e6e6d5cfcd23303eadb3c12bf8f6353b888ae9f3b072e012c49c9b16212551151309de92d487648142866167b1a2655f88bfe89a4cb1e6cfa9e2e10b38f614e7202abca1e6dfd8e53241b747200d4b066586c5085e0067e6f0eabc509457011345ac1a64c7241116b19c0af4f1b2a582342187c127723510a464322ddb310777a0fd6b799fe187d7844ad8289ecc3bb89e8f896a3efb7d65a34fd9a7846f9c53644dfba771193f6ef9d1b7e5a343152caaf6714724c9aa689fbcbae0c6a5035e99b0d68016f3556a0c5f8c690cbf2d7e9b9e4b66827c582ecbe02436e2382a76835ecb05d0dea8b7310d0bbb8d9e88fe782d8ab91cd5d30473629458abe143a5b2bdab9573af7cb042b9def9bfe1a7c88ed4b39583d8be53457d4b1ac92506cc0efd1a314712d4bc5a0acde4025b1dfed8ebadfa1d2241ac4f8f29bcea010749ff688eb3756700466092557347b3545c5b1e68ff39cbbd50d7ed2f24437b5d0691900614d3ff091a6d21673a5986e4cc094285a483d2e4b3e1cdae4be823e52fe97a6c88bee4a6a345aec8d0f62fd981a27092bd49878112c422a4f4060ab9a85a722026300f897375b600fd2a0be837153270a5e6f9aae2c1a03301c28ffcc3f0d7c4a1f3d94b47704bfcb0c75e68a98fd9ba64b6996a6fbd9a7877e092c459cf8d5a1caa22419c1e3dbead7f5a8885b28136a7a173250711edfb3437ed7f53103facb3403d4f63111ddabff96a9dae58c1775f599d1b499a4daf8fca8b8ca75004f2a96b44977b18d200f8be748213a54d6b3b28ca498dfb34c25026c2c4907271c72c2a3630ee6832f121133014d620ba9c7e98c4d6d61506240c3e34c2faec1204c204f80f2c3fe25074568c5f3d4e2d3e090a26d5c2b1fcefc042646667a093b4ff58c5d313154a4996446ddedd4f647671c6bacc5e5810d79b8d02e13edcf6d5cf7d54767a7d40178274a4220650ac3af172a83a15d6fe7d61a2d2c0e80a050260d647201dbb2d0b2b5d94d2838054361affbe496ef9ac7a2537156682c10a18ee08ca8c14826dbbeae90b38f6905056c4927c6a34e6ecda31c7d721f5c39605d0624165a7c15a0ce05603c1cb3818fad41611073137cdeb2ea851466003de3c1bd90e9df7f49586bdee6d9e1a194f1d3dafa3546ff8b4f36d4b80560dfe2f9db6c5c1e3c5e7e60173b5224405a2e076f023f55776d5c3e1c331322519ce5d2bf0765c3ac7f13a19cf6d4ffcd47767542e7c56141a5d37019e390224b96f46d01ea8fa29f77551c4895e753260b6e6d4f8fb1e4d8042b026eec851977dabf96a8635fe5caa6cf650b294d2c456506ef8eb1c5543b23515e111c6c6014b7de9cf3ec82295ab58b4e7289faf89da5d7573e5b3eb1c2d4eabcfac0a16b07cfbc284dbc80052acab9a1c4087a80e9d7b2394aa799fac6f082ceaba0d4085c9be2ec9c9cf90937afeb452a9fea2f4dc0aca4c1cdf1be91beccef8a2e5a5e0a95eccdbd1b7e3d03b38f2c413b5a621a3a78f697d5a732419ad85534791a472c5769d0e0e2de624d6c010869631bd391006141330f7cb4f6b0d18be8761d1927d2eeeb8eb7d9a2c34e2cbdd1a9cce1a02e42badfccbe2753f28197a935731978caa6b6c54d28d6ea85aa680d6709e382c0a280ecc4a11a5ba8c406633547fb8f097a417f6e522f4a345a37566200fa9671147d3e660b5521d8aabfc6310ff1b7debf68043c4f690cfcc01e311e7b8fe1e48534564c205a3f6c2f1d70afdbacdee198112febd76702385648297c1e3c50a1c4d990b8d6186c700287e6b5d7badbaedcd6e8dd9ba1c07f13493aa8cd75492c030a6fadc365045735acc00267eba20f615f2bfa881a7b8fed6c0d1260ab95d8e4d1fe2b465f303e5a7a0fb3dff89d437df30facc16a2a3a05278128239bf4ade1
</metadata>
//+------------------------------------------------------------------+
//|                                                          ADX.mq4 |
//|                      Copyright © 2004, MetaQuotes Software Corp. |
//|                                       http://www.metaquotes.net/ |
//+------------------------------------------------------------------+
#property copyright "Copyright © 2004, MetaQuotes Software Corp."
#property link      "http://www.metaquotes.net/"

#property indicator_separate_window
#property indicator_buffers 3
#property indicator_color1 LightSeaGreen
#property indicator_color2 YellowGreen
#property indicator_color3 Wheat

//---- input parameters
extern int ADXPeriod=14;
//---- buffers
double ADXBuffer[];
double PlusDiBuffer[];
double MinusDiBuffer[];
double PlusSdiBuffer[];
double MinusSdiBuffer[];
double TempBuffer[];
//+------------------------------------------------------------------+
//| Custom indicator initialization function                         |
//+------------------------------------------------------------------+
int init()
  {
//---- 3 additional buffers are used for counting.
   IndicatorBuffers(3);
//---- indicator buffers
   SetIndexBuffer(0,PlusDiBuffer);
   SetIndexBuffer(1,MinusDiBuffer);
   SetIndexBuffer(2,ADXBuffer);

   SetIndexBuffer(3,PlusSdiBuffer);
   SetIndexBuffer(4,MinusSdiBuffer);
   SetIndexBuffer(5,TempBuffer);
   
   
   

//---- name for DataWindow and indicator subwindow label
   IndicatorShortName("ADX("+ADXPeriod+")");
   SetIndexLabel(0,"ADX");
   SetIndexLabel(1,"+DI");
   SetIndexLabel(2,"-DI");
//----
   SetIndexDrawBegin(0,ADXPeriod);
   SetIndexDrawBegin(1,ADXPeriod);
   SetIndexDrawBegin(2,ADXPeriod);
//----
   return(0);
  }
//+------------------------------------------------------------------+
//| Average Directional Movement Index                               |
//+------------------------------------------------------------------+
int start()
  {
   double pdm,mdm,tr;
   double price_high,price_low;
   int    starti,i,counted_bars=IndicatorCounted();
//----
   i=Bars-2;
   PlusSdiBuffer[i+1]=0;
   MinusSdiBuffer[i+1]=0;
   if(counted_bars>=i) i=Bars-counted_bars-1;
   starti=i;
//----
   while(i>=0)
     {
      price_low=Low[i];
      price_high=High[i];
      //----
      pdm=price_high-High[i+1];
      mdm=Low[i+1]-price_low;
      if(pdm<0) pdm=0;  // +DM
      if(mdm<0) mdm=0;  // -DM
      if(pdm==mdm) { pdm=0; mdm=0; }
      else if(pdm<mdm) pdm=0;
           else if(mdm<pdm) mdm=0;
      //---- вычисляем истинный интервал
      double num1=MathAbs(price_high-price_low);
      double num2=MathAbs(price_high-Close[i+1]);
      double num3=MathAbs(price_low-Close[i+1]);
      tr=MathMax(num1,num2);
      tr=MathMax(tr,num3);
      //---- counting plus/minus direction
      if(tr==0) { PlusSdiBuffer[i]=0; MinusSdiBuffer[i]=0; }
      else      { PlusSdiBuffer[i]=100.0*pdm/tr; MinusSdiBuffer[i]=100.0*mdm/tr; }
      if (PlusSdiBuffer[i]<0.001)
      	PlusSdiBuffer[i] = 0.001;
      if (MinusSdiBuffer[i]<0.001)
        MinusSdiBuffer[i] = 0.001;
      //----
      i--;
     }
     
     
//---- last counted bar will be recounted
   if(counted_bars>0) counted_bars--;
   int limit=Bars-counted_bars;
//---- apply EMA to +DI
   for(i=0; i<=limit; i++)
      PlusDiBuffer[i]=iMAOnArray(PlusSdiBuffer,Bars,ADXPeriod,0,MODE_EMA,i);
//---- apply EMA to -DI
   for(i=0; i<=limit; i++)
      MinusDiBuffer[i]=iMAOnArray(MinusSdiBuffer,Bars,ADXPeriod,0,MODE_EMA,i);
//---- Directional Movement (DX)
   i=Bars-2;
   TempBuffer[i+1]=0;
   i=starti;
   while(i>=0)
     {
      double div=MathAbs(PlusDiBuffer[i]+MinusDiBuffer[i]);
      if(div==0.00) TempBuffer[i]=0;
      else TempBuffer[i]=100*(MathAbs(PlusDiBuffer[i]-MinusDiBuffer[i])/div);
      i--;
     }
//---- ADX is exponential moving average on DX
   for(i=0; i<limit; i++)
      ADXBuffer[i]=iMAOnArray(TempBuffer,Bars,ADXPeriod,0,MODE_EMA,i);
//----
   return(0);
  }
//+------------------------------------------------------------------+